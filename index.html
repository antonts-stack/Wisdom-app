<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wisdom</title>
  <style>
    :root{--bg:#000;--fg:#fff;--muted:#2a2a2a;--accent:#6ee7ff}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      display:flex;align-items:center;justify-content:center;padding:16px;
    }
    .wrap{width:100%;max-width:760px;display:flex;flex-direction:column;gap:14px}
    #card{
      border:1px solid var(--muted);border-radius:16px;padding:20px 18px;
      line-height:1.6;font-size:clamp(17px,2.2vh + .6vw,21px);
      white-space:pre-wrap;user-select:none;max-height:70vh;overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    select{
      appearance:none;background:#111;color:var(--fg);border:1px solid var(--muted);
      border-radius:999px;padding:10px 12px;font-size:14px
    }
    button{
      border:1px solid var(--muted);background:#111;color:var(--fg);
      padding:12px 18px;font-size:16px;border-radius:999px;cursor:pointer
    }
    button:active{transform:scale(.98)}
    .hint{font-size:13px;opacity:.6;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="card" aria-live="polite">Loading…</div>
    <div class="row">
      <select id="category"><option value="all">All</option></select>
      <button id="nextBtn">Next</button>
      <button id="refreshBtn" title="Force sync">Refresh</button>
      <button id="resetBtn" title="Clear cache + reload">Reset</button>
    </div>
    <div class="hint">Tap the text or press Next • Refresh pulls latest from Google Sheets</div>
  </div>

  <script>
    // Google Sheets (gviz JSON) — preserves in-cell newlines (Alt/Option+Enter)
    const GVIZ_URL =
      "https://docs.google.com/spreadsheets/d/1rpEUSGMShAkhFnYIGi_eUcYnWyef77bm2z8Xt33OPr0/gviz/tq?tqx=out:json&gid=0";

    let items = [];
    let byCat = new Map();

    function show(msg){ document.getElementById("card").textContent = msg; }

    function parseGviz(raw){
      // Strip wrapper: google.visualization.Query.setResponse(...)
      const json = raw.replace(/^[^{]+/, "").replace(/;?$/,"");
      const data = JSON.parse(json);

      const cols = data.table.cols.map(c => (c.label || "").toLowerCase().trim());
      let tIdx = cols.indexOf("text"); if (tIdx < 0) tIdx = 0;
      let cIdx = cols.indexOf("category"); if (cIdx < 0) cIdx = 1;

      const out = [];
      for (const r of data.table.rows) {
        const c = r.c || [];
        const t = (c[tIdx] && (c[tIdx].v ?? c[tIdx].f)) ?? "";
        if (!String(t).trim()) continue;
        let cat = (c[cIdx] && (c[cIdx].v ?? c[cIdx].f)) ?? "general";
        cat = String(cat || "general").trim() || "general";
        out.push({ text: String(t).replace(/\r\n/g,"\n").replace(/\r/g,"\n"), category: cat });
      }
      return out;
    }

    function buildCategories(){
      const sel = document.getElementById("category");
      const cats = [...new Set(items.map(x => x.category || "general"))].sort();
      sel.innerHTML = '<option value="all">All</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join("");
      byCat = new Map();
      for (const it of items){
        const k = it.category || "general";
        if (!byCat.has(k)) byCat.set(k, []);
        byCat.get(k).push(it);
      }
    }

    function pool(){ const v = document.getElementById("category").value; return v === "all" ? items : (byCat.get(v)||[]); }

    function next(){
      const p = pool(); const card = document.getElementById("card");
      if (!p.length){ show("No entries."); return; }
      const i = Math.floor(Math.random() * p.length);
      card.scrollTop = 0;
      card.textContent = p[i].text; // newlines preserved by CSS white-space: pre-wrap
    }

    async function fetchLive(){
      // Cache-bust so new edits show as soon as Google propagates them
      const url = GVIZ_URL + "&t=" + Date.now();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const raw = await r.text();
      const data = parseGviz(raw);
      if (!data.length) throw new Error("0 rows (check headers `text` / `category`, and gid)");
      return data;
    }

    async function loadData({forceNetwork=false} = {}){
      try{
        if (forceNetwork) localStorage.removeItem("wisdom_cache");
        items = await fetchLive();
        localStorage.setItem("wisdom_cache", JSON.stringify(items));
      }catch(e){
        const cached = localStorage.getItem("wisdom_cache");
        if (cached) {
          items = JSON.parse(cached);
        } else {
          show("Couldn't load data: " + e.message);
          return;
        }
      }
      buildCategories(); next();
    }

    // UI
    document.getElementById("nextBtn").addEventListener("click", next);
    document.getElementById("card").addEventListener("click", next);
    document.getElementById("category").addEventListener("change", next);
    document.getElementById("refreshBtn").addEventListener("click", () => loadData({forceNetwork:true}));
    document.getElementById("resetBtn").addEventListener("click", () => { localStorage.clear(); location.reload(); });

    // Auto-refresh on app foreground
    document.addEventListener("visibilitychange", () => { if (!document.hidden) loadData({forceNetwork:true}); });

    // Initial load
    loadData({forceNetwork:true});
  </script>
</body>
</html>
