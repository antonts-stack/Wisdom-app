<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wisdom</title>
  <style>
    :root{--bg:#000;--fg:#fff;--muted:#2a2a2a;--accent:#6ee7ff}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      display:flex;align-items:center;justify-content:center;padding:16px;
    }
    .wrap{width:100%;max-width:760px;display:flex;flex-direction:column;gap:14px}
    #card{
      border:1px solid var(--muted);border-radius:16px;padding:20px 18px;
      line-height:1.6;font-size:clamp(17px,2.2vh + .6vw,21px);
      white-space:pre-wrap;user-select:none;max-height:70vh;overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    select{
      appearance:none;background:#111;color:var(--fg);border:1px solid var(--muted);
      border-radius:999px;padding:10px 12px;font-size:14px
    }
    button{
      border:1px solid var(--muted);background:#111;color:var(--fg);
      padding:12px 18px;font-size:16px;border-radius:999px;cursor:pointer
    }
    button:active{transform:scale(.98)}
    .hint{font-size:13px;opacity:.6;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="card" aria-live="polite">Loadingâ€¦</div>
    <div class="row">
      <select id="category"><option value="all">All</option></select>
      <button id="nextBtn">Next</button>
    </div>
    <div class="hint">Tap the text or press Next</div>
  </div>

  <script>
    /* ---------- Auto cache-bust the shell ---------- */
    const APP_VERSION = "v3"; // bump this when you deploy new code
    (function ensureFresh(){
      const u = new URL(location.href);
      if (u.searchParams.get("v") !== APP_VERSION){
        u.searchParams.set("v", APP_VERSION);
        location.replace(u.toString()); // reload once with ?v=<APP_VERSION>
      }
    })();
    /* ---------------------------------------------- */

    // Sheet config
    const SHEET_ID = "1rpEUSGMShAkhFnYIGi_eUcYnWyef77bm2z8Xt33OPr0";
    const GID = "0";

    // Primary (GVIZ JSON preserves in-cell newlines); CSV fallback
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
    const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

    let items = [];
    let byCat = new Map();

    function show(msg){ document.getElementById("card").textContent = msg; }

    // --- GVIZ robust extractor ---
    function extractGvizJSON(raw){
      const m = raw.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\)\s*;?\s*$/);
      if (m && m[1]) return JSON.parse(m[1]);
      const start = raw.indexOf("{"), end = raw.lastIndexOf("}");
      if (start === -1 || end === -1 || end <= start) throw new Error("Unexpected GVIZ response");
      return JSON.parse(raw.slice(start, end + 1));
    }

    function parseGviz(raw){
      const data = extractGvizJSON(raw);
      const cols = data.table.cols.map(c => (c.label || "").toLowerCase().trim());
      let tIdx = cols.indexOf("text"); if (tIdx < 0) tIdx = 0;
      let cIdx = cols.indexOf("category"); if (cIdx < 0) cIdx = 1;

      const out = [];
      for (const r of data.table.rows) {
        const c = r.c || [];
        const t = (c[tIdx] && (c[tIdx].v ?? c[tIdx].f)) ?? "";
        if (!String(t).trim()) continue;
        let cat = (c[cIdx] && (c[cIdx].v ?? c[cIdx].f)) ?? "general";
        cat = String(cat || "general").trim() || "general";
        out.push({ text: String(t).replace(/\r\n/g,"\n").replace(/\r/g,"\n"), category: cat });
      }
      return out;
    }

    // --- CSV parser (handles quotes + embedded newlines) ---
    function parseCSV(text){
      const rows = []; let row=[], field="", i=0, q=false;
      while (i<text.length){
        const ch=text[i];
        if (q){
          if (ch === '"'){ if (text[i+1] === '"'){ field+='"'; i+=2; continue; } q=false; i++; continue; }
          field+=ch; i++; continue;
        } else {
          if (ch === '"'){ q=true; i++; continue; }
          if (ch === ","){ row.push(field); field=""; i++; continue; }
          if (ch === "\r"){ i++; continue; }
          if (ch === "\n"){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
          field+=ch; i++;
        }
      }
      row.push(field); rows.push(row);
      if (!rows.length) return [];
      const headers = rows[0].map(h => (h||"").trim().toLowerCase());
      const tIdx = headers.indexOf("text");
      const cIdx = headers.indexOf("category");
      const out = [];
      for (let r=1;r<rows.length;r++){
        const cols=rows[r];
        const t=(cols[tIdx]||"").trim(); if (!t) continue;
        let cat=((cIdx!==-1?cols[cIdx]:"")||"general").trim()||"general";
        out.push({ text: t.replace(/\r\n/g,"\n").replace(/\r/g,"\n"), category: cat });
      }
      return out;
    }

    function buildCategories(){
      const sel=document.getElementById("category");
      const cats=[...new Set(items.map(x=>x.category||"general"))].sort();
      sel.innerHTML='<option value="all">All</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join("");
      byCat=new Map();
      for (const it of items){ const k=it.category||"general"; (byCat.get(k)||byCat.set(k,[]).get(k)).push(it); }
    }

    function pool(){ const v=document.getElementById("category").value; return v==="all"?items:(byCat.get(v)||[]); }

    function next(){
      const p=pool(), card=document.getElementById("card");
      if(!p.length){ show("No entries."); return; }
      const i=Math.floor(Math.random()*p.length);
      card.scrollTop=0;
      card.textContent=p[i].text;
    }

    async function fetchText(url){
      const r=await fetch(url + "&t=" + Date.now(), {cache:"no-store"});
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    }

    async function fetchLive(){
      try{
        const raw=await fetchText(GVIZ_URL);
        const data=parseGviz(raw);
        if(!data.length) throw new Error("0 rows");
        return data;
      }catch(e){
        const raw=await fetchText(CSV_URL);
        const data=parseCSV(raw);
        if(!data.length) throw new Error("CSV fallback empty (check headers/gid)");
        return data;
      }
    }

    async function loadData({forceNetwork=false} = {}){
      try{
        if (forceNetwork) localStorage.removeItem("wisdom_cache");
        items = await fetchLive();
        localStorage.setItem("wisdom_cache", JSON.stringify(items));
      }catch(e){
        const cached = localStorage.getItem("wisdom_cache");
        if (cached) { items = JSON.parse(cached); }
        else { show("Couldn't load data: " + e.message); return; }
      }
      buildCategories(); next();
    }

    // UI
    document.getElementById("nextBtn").addEventListener("click", next);
    document.getElementById("card").addEventListener("click", next);
    document.getElementById("category").addEventListener("change", next);

    // Auto-refresh when returning to the app
    document.addEventListener("visibilitychange", () => { if (!document.hidden) loadData({forceNetwork:true}); });

    // Initial load (network-first)
    loadData({forceNetwork:true});
  </script>
</body>
</html>
